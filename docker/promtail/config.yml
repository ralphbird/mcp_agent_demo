server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  - job_name: containers
    static_configs:
      - targets:
          - localhost
        labels:
          job: containerlogs
          __path__: /var/lib/docker/containers/*/*log

    pipeline_stages:
      - json:
          expressions:
            output: log
            stream: stream
            attrs:
      - json:
          expressions:
            tag:
          source: attrs
      - regex:
          expression: (?P<container_name>(?:[^|]*))\|
          source: tag
      - timestamp:
          format: RFC3339Nano
          source: time
      - labels:
          stream:
          container_name:
      - output:
          source: output

  # Scrape logs from currency-api container
  - job_name: currency-api
    static_configs:
      - targets:
          - localhost
        labels:
          job: currency-api
          service: currency-api
          __path__: /var/lib/docker/containers/*/*log

    pipeline_stages:
      - json:
          expressions:
            output: log
            stream: stream
            attrs:
      - json:
          expressions:
            tag:
          source: attrs
      - regex:
          expression: (?P<container_name>(?:[^|]*))\|
          source: tag
      - match:
          selector: '{container_name="currency-api"}'
          stages:
            - json:
                expressions:
                  timestamp: timestamp
                  level: level
                  logger: logger
                  message: message
                  service: service
                  request_id: request_id
                  endpoint: endpoint
                  method: method
                  status_code: status_code
                  response_time_ms: response_time_ms
                  from_currency: from_currency
                  to_currency: to_currency
                  amount: amount
                source: output
            - labels:
                level:
                service:
                logger:
                method:
                endpoint:
            - timestamp:
                format: "2006-01-02T15:04:05"
                source: timestamp
      - output:
          source: output

  # Scrape logs from load-tester container
  - job_name: load-tester
    static_configs:
      - targets:
          - localhost
        labels:
          job: load-tester
          service: load-tester
          __path__: /var/lib/docker/containers/*/*log

    pipeline_stages:
      - json:
          expressions:
            output: log
            stream: stream
            attrs:
      - json:
          expressions:
            tag:
          source: attrs
      - regex:
          expression: (?P<container_name>(?:[^|]*))\|
          source: tag
      - match:
          selector: '{container_name="currency-load-tester"}'
          stages:
            - json:
                expressions:
                  timestamp: timestamp
                  level: level
                  logger: logger
                  message: message
                  service: service
                  request_id: request_id
                  endpoint: endpoint
                  method: method
                  status_code: status_code
                  response_time_ms: response_time_ms
                  load_test_id: load_test_id
                  requests_per_second: requests_per_second
                  duration_seconds: duration_seconds
                  worker_count: worker_count
                source: output
            - labels:
                level:
                service:
                logger:
                method:
                endpoint:
            - timestamp:
                format: "2006-01-02T15:04:05"
                source: timestamp
      - output:
          source: output
